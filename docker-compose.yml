# Общий шаблон для сервисов (API, worker, guard)
# Позволяет не дублировать image, restart, env_file и т.д.
x-common: &common
  image: xray-agent:latest              # Образ приложения (API / worker / guard)
  restart: unless-stopped               # Автоперезапуск при падении
  env_file:
    - .env                              # Переменные окружения из файла
  volumes:
    - /var/log/xray:/var/log/xray:ro    # Логи Xray (только чтение)
    - /etc/localtime:/etc/localtime:ro  # Синхронизация времени контейнера с хостом
  depends_on:
    redis:
      condition: service_healthy        # Ждём пока Redis станет healthy
  logging:
    driver: "json-file"
    options:
      max-size: "50m"                   # Ротация логов
      max-file: "5"

services:
  redis:
    image: redis:7-alpine
    container_name: xray-agent-redis
    restart: unless-stopped
    command: >
      redis-server
      --port 6379
      --save ""
      --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "redis:6379"
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  xray-agent-api:
    <<: *common
    build: .
    environment:
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      XRAY_API_ADDR: "host.docker.internal:10085"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "18000:18000"
    command: >
      python -m uvicorn app.main:app --host 0.0.0.0 --port 18000

  xray-agent-worker:
    <<: *common
    environment:
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      XRAY_API_ADDR: "host.docker.internal:10085"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: [ "python", "worker.py" ]

  xray-guard:
    <<: *common
    environment:
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      XRAY_API_ADDR: "host.docker.internal:10085"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: [ "python", "-m", "app.workers.xray_guard.main" ]


volumes:
  redis-data:
