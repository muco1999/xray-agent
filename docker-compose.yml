version: "3.9"

x-common: &common
  image: xray-agent:latest
  restart: unless-stopped
  env_file:
    - .env
  volumes:
    - /var/log/xray:/var/log/xray:ro
    - /etc/localtime:/etc/localtime:ro
  depends_on:
    redis:
      condition: service_healthy
  logging:
    driver: "json-file"
    options:
      max-size: "50m"
      max-file: "5"

services:
  redis:
    image: redis:7-alpine
    container_name: xray-agent-redis
    restart: unless-stopped
    command: >
      redis-server
      --port 6379
      --save ""
      --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # ✅ единственный билд
  xray-agent-api:
    <<: *common
    build: .
    container_name: xray-agent-api
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    ports:
      - "${API_BIND_HOST:-0.0.0.0}:${API_BIND_PORT:-18000}:18000"
    command: >
      python -m uvicorn app.main:app
      --host 0.0.0.0
      --port 18000

  # ✅ только image, без build
  xray-agent-worker:
    <<: *common
    container_name: xray-agent-worker
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    command: ["python", "worker.py"]

  # ✅ только image, без build
  xray-guard:
    <<: *common
    container_name: xray-guard
    environment:
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    command: ["python", "-m", "app.workers.xray_guard.main"]

volumes:
  redis-data:
